<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.5, user-scalable=yes, viewport-fit=cover">
    <title>Excel نظام متكامل</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <!-- SheetJS -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    
    <!-- Font Awesome 6 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">
    
    <style>
        /* ===== متغيرات الألوان ===== */
        :root {
            --primary: #0f6c3e;
            --primary-light: #1e8b4c;
            --primary-dark: #0a4e2e;
            --secondary: #2563eb;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            --purple: #8b5cf6;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* ===== تطبيق كامل الشاشة ===== */
        .app-wrapper {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
            height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ===== شاشة تسجيل الدخول ===== */
        .login-container {
            max-width: 480px;
            margin: 80px auto;
            background: white;
            border-radius: 24px;
            padding: 48px 40px;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
            text-align: center;
        }

        .login-logo {
            font-size: 64px;
            color: var(--primary);
            margin-bottom: 24px;
        }

        .login-title {
            color: var(--gray-900);
            font-size: 32px;
            font-weight: 900;
            margin-bottom: 8px;
        }

        .login-subtitle {
            color: var(--gray-500);
            margin-bottom: 32px;
            font-size: 16px;
        }

        .login-input {
            width: 100%;
            padding: 14px 18px;
            margin-bottom: 16px;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .login-btn {
            width: 100%;
            padding: 14px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
        }

        /* ===== شريط العنوان العلوي ===== */
        .title-bar {
            background: var(--primary);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            flex-wrap: wrap;
            gap: 10px;
        }

        .excel-logo {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .excel-logo i {
            font-size: 28px;
            color: white;
        }

        .excel-logo span {
            font-size: 20px;
            font-weight: 900;
            color: white;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .user-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255,255,255,0.2);
            padding: 6px 14px;
            border-radius: 40px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-weight: 900;
            font-size: 14px;
        }

        .user-email {
            color: white;
            font-size: 14px;
            font-weight: 600;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 6px 14px;
            border-radius: 40px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* ===== شريط التبويبات ===== */
        .tab-bar {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            padding: 0 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            flex-wrap: wrap;
            gap: 10px;
        }

        .tabs {
            display: flex;
            gap: 4px;
            overflow-x: auto;
            padding: 8px 0;
            flex: 1;
            -webkit-overflow-scrolling: touch;
        }

        .tab {
            padding: 12px 16px;
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-500);
            cursor: pointer;
            border-bottom: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }

        .tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .upload-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 40px;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            white-space: nowrap;
        }

        /* ===== صفحة اختيار الملفات والأوراق - الصفحة الرئيسية ===== */
        .selection-page {
            flex: 1;
            overflow-y: auto;
            background: var(--gray-50);
            padding: 20px;
            -webkit-overflow-scrolling: touch;
        }

        .selection-section {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 800;
            color: var(--gray-900);
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .files-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 16px;
        }

        .file-card {
            background: var(--gray-50);
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .file-card:hover {
            border-color: var(--primary);
            background: var(--gray-100);
        }

        .file-card.active {
            border-color: var(--primary);
            background: #e6f7ed;
        }

        .file-card-icon {
            font-size: 48px;
            color: var(--primary);
            margin-bottom: 12px;
        }

        .file-card-name {
            font-size: 16px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 8px;
        }

        .file-card-info {
            font-size: 12px;
            color: var(--gray-500);
        }

        .file-delete-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--danger);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0.8;
        }

        .sheets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .sheet-card {
            background: var(--gray-50);
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .sheet-card:hover {
            border-color: var(--primary);
            background: var(--gray-100);
        }

        .sheet-card.active {
            border-color: var(--primary);
            background: #e6f7ed;
        }

        .sheet-card-name {
            font-size: 14px;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sheet-card-info {
            font-size: 16px;
            color: var(--gray-500);
        }

        .add-card {
            background: var(--gray-50);
            border: 2px dashed var(--gray-300);
            border-radius: 12px;
            padding: 20px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
            min-height: 150px;
        }

        .add-card:hover {
            border-color: var(--primary);
            background: var(--gray-100);
        }

        .add-card i {
            font-size: 32px;
            color: var(--primary);
        }

        .add-card span {
            font-weight: 600;
            color: var(--gray-700);
        }

        .open-table-btn {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 800;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-top: 20px;
        }

        .open-table-btn:disabled {
            background: var(--gray-300);
            cursor: not-allowed;
        }

        /* ===== صفحة الجدول المستقلة - ملء الشاشة ===== */
        .table-page {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 10000;
            display: none;
            flex-direction: column;
        }

        .table-page.active {
            display: flex;
        }

        .table-header {
            background: var(--primary);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
            color: white;
        }

        .table-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
        }

        .table-title {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .table-title-main {
            font-size: 16px;
            font-weight: 800;
        }

        .table-title-sub {
            font-size: 12px;
            opacity: 0.9;
        }

        .table-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .table-action-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 16px;
        }

        /* ===== شريط الأدوات للجدول ===== */
        .table-toolbar {
            background: var(--gray-50);
            border-bottom: 1px solid var(--gray-200);
            padding: 10px 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .tool-btn {
            padding: 8px 14px;
            border: none;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            color: white;
            white-space: nowrap;
        }

        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }

        /* ===== لوحة تحكم المدير ===== */
        .permissions-panel {
            background: linear-gradient(135deg, #f0f9ff 0%, #e6f2ff 100%);
            border-bottom: 2px solid var(--primary);
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .permissions-title {
            display: flex;
            align-items: center;
            gap: 6px;
            color: var(--gray-800);
            font-weight: 800;
            font-size: 13px;
        }

        .permission-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            background: white;
            padding: 6px 12px;
            border-radius: 40px;
            border: 2px solid var(--gray-200);
        }

        .permission-toggle span {
            font-size: 12px;
            font-weight: 600;
            color: var(--gray-700);
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: var(--gray-300);
            border-radius: 50px;
            cursor: pointer;
        }

        .toggle-switch.active {
            background: var(--success);
        }

        .toggle-slider {
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            right: 2px;
            transition: all 0.3s;
        }

        .toggle-switch.active .toggle-slider {
            right: 22px;
        }

        /* ===== منطقة الجدول ===== */
        .table-container {
            flex: 1;
            overflow: auto !important;
            position: relative;
            min-height: 0;
            -webkit-overflow-scrolling: touch;
        }

        .table-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 4px;
        }

        table {
            border-collapse: collapse;
            min-width: 100%;
            font-size: 16px;
        }

        th {
            background: var(--gray-800);
            color: white;
            padding: 10px 12px;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 20;
            white-space: nowrap;
            font-size: 13px;
        }

        td {
            border: 1px solid var(--gray-200);
            padding: 8px 10px;
            text-align: center;
            min-width: 100px;
            white-space: nowrap;
            background: white;
            font-size: 13px;
        }

        .row-header {
            background: var(--gray-100);
            font-weight: 700;
            position: sticky;
            left: 0;
            z-index: 15;
            min-width: 50px;
        }

        /* ===== إدارة المستخدمين ===== */
        .users-container {
            padding: 20px;
            overflow-y: auto;
            height: 100%;
            background: var(--gray-50);
            -webkit-overflow-scrolling: touch;
        }

        .users-header h2 {
            font-size: 24px;
            font-weight: 900;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .add-user-card {
            background: white;
            padding: 20px;
            border-radius: 16px;
            margin-bottom: 24px;
        }

        .add-user-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 12px;
        }

        .role-select {
            padding: 12px 16px;
            border: 2px solid var(--gray-200);
            border-radius: 12px;
            font-size: 14px;
            background: white;
        }

        .user-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        /* ===== سجل التعديلات ===== */
        .logs-container {
            padding: 20px;
            overflow-y: auto;
            height: 100%;
            background: var(--gray-50);
            -webkit-overflow-scrolling: touch;
        }

        .logs-header h2 {
            font-size: 24px;
            font-weight: 900;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .logs-list {
            background: white;
            padding: 20px;
            border-radius: 16px;
        }

        .log-item {
            padding: 16px;
            border-bottom: 1px solid var(--gray-200);
        }

        /* ===== النسخ الاحتياطية ===== */
        .backups-container {
            padding: 20px;
            overflow-y: auto;
            height: 100%;
            background: var(--gray-50);
            -webkit-overflow-scrolling: touch;
        }

        .backups-header h2 {
            font-size: 24px;
            font-weight: 900;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .create-backup-btn {
            background: var(--purple);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .backup-item {
            background: white;
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .backup-details {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
            font-size: 12px;
            color: var(--gray-500);
        }

        .restore-backup-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
        }

        /* ===== الإشعارات ===== */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            left: 20px;
            padding: 14px 20px;
            background: var(--primary);
            color: white;
            border-radius: 12px;
            display: none;
            align-items: center;
            gap: 12px;
            z-index: 99999;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            max-width: 400px;
            margin: 0 auto;
        }

        /* ===== تحسينات الهاتف المحمول ===== */
        @media (max-width: 1024px) {
            .add-user-form {
                grid-template-columns: 1fr 1fr;
            }
            
            .files-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 0;
            }
            
            .app-wrapper {
                height: 100vh;
                border-radius: 0;
            }
            
            .login-container {
                margin: 40px 20px;
                padding: 32px 24px;
            }
            
            .login-title {
                font-size: 28px;
            }
            
            .login-logo {
                font-size: 56px;
            }
            
            .title-bar {
                padding: 10px 16px;
            }
            
            .excel-logo span {
                font-size: 18px;
            }
            
            .user-email {
                display: none;
            }
            
            .tab {
                padding: 10px 14px;
                font-size: 13px;
            }
            
            .selection-page {
                padding: 16px;
            }
            
            .files-grid {
                grid-template-columns: 1fr;
            }
            
            .sheets-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .table-toolbar {
                padding: 8px 12px;
            }
            
            .tool-btn {
                padding: 6px 12px;
                font-size: 11px;
            }
            
            .permissions-panel {
                padding: 10px 12px;
            }
            
            .permission-toggle {
                padding: 5px 10px;
            }
            
            th, td {
                padding: 8px;
                font-size: 12px;
                min-width: 80px;
            }
            
            .row-header {
                min-width: 45px;
            }
            
            .users-container, .logs-container, .backups-container {
                padding: 16px;
            }
            
            .users-header h2, .logs-header h2, .backups-header h2 {
                font-size: 22px;
            }
            
            .add-user-form {
                grid-template-columns: 1fr;
            }
            
            .table-container::-webkit-scrollbar {
                width: 6px;
                height: 6px;
            }
        }

        @media (max-width: 480px) {
            .excel-logo span {
                display: none;
            }
            
            .excel-logo i {
                font-size: 24px;
            }
            
            .tab {
                padding: 8px 12px;
                font-size: 12px;
            }
            
            .tool-btn span {
                display: none;
            }
            
            .tool-btn i {
                font-size: 16px;
            }
            
            .tool-btn {
                padding: 8px;
                width: 40px;
                height: 40px;
                border-radius: 50%;
            }
            
            .permission-toggle span:first-child {
                display: none;
            }
            
            .table-title-sub {
                display: none;
            }
        }

        @media (hover: none) and (pointer: coarse) {
            .file-card, .sheet-card, .tool-btn, .tab, .add-card {
                min-height: 44px;
            }
        }
    </style>
</head>
<body>
    <!-- شاشة تسجيل الدخول -->
    <div id="loginScreen" class="login-container">
        <div class="login-logo">
            <i class="fas fa-table"></i>
        </div>
        <h1 class="login-title">Excel تعاوني</h1>
        <p class="login-subtitle">نظام متكامل </p>
        
        <input type="email" id="loginEmail" class="login-input" placeholder="البريد الإلكتروني" value="admin@excel.com">
        <input type="password" id="loginPassword" class="login-input" placeholder="كلمة المرور" value="123456789">
        
        <button onclick="handleLogin()" class="login-btn">
            <i class="fas fa-sign-in-alt"></i> تسجيل الدخول
        </button>
    </div>

    <!-- التطبيق الرئيسي -->
    <div id="appScreen" class="app-wrapper" style="display: none;">
        
        <!-- شريط العنوان -->
        <div class="title-bar">
            <div class="excel-logo">
                <i class="fas fa-table"></i>
                <span>Excel نظام</span>
            </div>
            <div class="user-section">
                <div class="user-badge">
                    <div class="user-avatar" id="userAvatar">A</div>
                    <span class="user-email" id="userEmail">admin@excel.com</span>
                </div>
                <button class="logout-btn" onclick="handleLogout()">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </div>

        <!-- شريط التبويبات -->
        <div class="tab-bar">
            <div class="tabs" id="mainTabs">
                <div class="tab active" onclick="switchMainTab('excel', this)">
                    <i class="fas fa-table"></i><span>الجداول</span>
                </div>
                <div class="tab" onclick="switchMainTab('users', this)" id="usersTab">
                    <i class="fas fa-users"></i><span>المستخدمين</span>
                </div>
                <div class="tab" onclick="switchMainTab('logs', this)" id="logsTab">
                    <i class="fas fa-history"></i><span>سجل التعديلات</span>
                </div>
                <div class="tab" onclick="switchMainTab('backups', this)" id="backupsTab">
                    <i class="fas fa-archive"></i><span>النسخ الاحتياطية</span>
                </div>
            </div>
            <div id="uploadButtonContainer">
                <input type="file" id="excelFile" accept=".xlsx,.xls" onchange="uploadExcel()" style="display: none;">
                <button class="upload-btn" onclick="document.getElementById('excelFile').click()">
                    <i class="fas fa-cloud-upload-alt"></i><span>رفع</span>
                </button>
            </div>
        </div>

        <!-- المحتوى الديناميكي -->
        <div id="dynamicContent" style="flex: 1; display: flex; flex-direction: column; overflow: hidden;"></div>
    </div>

    <!-- صفحة الجدول المستقلة -->
    <div id="tablePage" class="table-page">
        <div class="table-header">
            <div class="table-header-left">
                <button class="back-btn" onclick="closeTablePage()">
                    <i class="fas fa-arrow-right"></i>
                </button>
                <div class="table-title">
                    <div class="table-title-main" id="tablePageFileName">الملف الرئيسي</div>
                    <div class="table-title-sub" id="tablePageSheetName">ورقة1</div>
                </div>
            </div>
            <div class="table-actions" id="tablePageActions"></div>
        </div>
        
        <div id="tablePageToolbar"></div>
        <div id="tablePagePermissions"></div>
        
        <div class="table-container" id="tablePageContainer"></div>
    </div>

    <!-- نافذة إضافة ورقة -->
    <div id="addSheetModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); align-items: center; justify-content: center; z-index: 100000;">
        <div style="background: white; padding: 24px; border-radius: 16px; width: 90%; max-width: 500px; margin: 20px;">
            <h3 style="margin-bottom: 20px;"><i class="fas fa-plus-circle" style="color: var(--success);"></i> إضافة ورقة جديدة</h3>
            <input type="text" id="newSheetNameInput" class="login-input" placeholder="اسم الورقة">
            <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;">
                <button onclick="hideModal('addSheetModal')" style="padding: 10px 20px; border-radius: 10px; border: none; background: var(--gray-200); font-weight: 600; cursor: pointer;">إلغاء</button>
                <button onclick="createNewSheet()" style="padding: 10px 20px; border-radius: 10px; border: none; background: var(--success); color: white; font-weight: 600; cursor: pointer;">إنشاء</button>
            </div>
        </div>
    </div>

    <!-- الإشعارات -->
    <div id="notification" class="notification"></div>

    <script>
        // ==================== إعدادات Firebase ====================
        const firebaseConfig = {
            apiKey: "AIzaSyB6n_O1GZkJrvY0qrnSg-LFRjoOaqKKDd8",
  authDomain: "dataexcel-72c92.firebaseapp.com",
  databaseURL: "https://dataexcel-72c92-default-rtdb.firebaseio.com",
  projectId: "dataexcel-72c92",
  storageBucket: "dataexcel-72c92.firebasestorage.app",
  messagingSenderId: "33675725947",
  appId: "1:33675725947:web:8288d29447dfc78a6f26de",
  measurementId: "G-0XLZ7F7BEL"
};

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // ==================== متغيرات عامة ====================
        let currentUser = null;
        let currentUserRole = 'admin';
        let currentExcelFile = null;
        let currentSheet = null;
        let excelFiles = {};
        let sheets = {};
        let currentSheetData = {};
        let mergedCells = [];
        let sheetsCache = {};
        let dataCache = {};
        
        let userPermissions = {
            view: true,
            edit: false
        };
        
        const MAX_ROWS = 1000;
        const MAX_COLS = 100;

        // ==================== نظام المصادقة ====================
        function handleLogin() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();
            
            if (!email || !password) {
                showNotification('❌ يرجى إدخال البريد الإلكتروني وكلمة المرور', 'error');
                return;
            }
            
            auth.signInWithEmailAndPassword(email, password)
                .catch(error => {
                    if (error.code === 'auth/user-not-found') {
                        auth.createUserWithEmailAndPassword(email, password)
                            .then(cred => {
                                return db.ref(`users/${cred.user.uid}`).set({
                                    email: email,
                                    role: 'admin',
                                    createdAt: new Date().toISOString()
                                });
                            })
                            .then(() => {
                                showNotification('✅ تم إنشاء حساب مدير بنجاح', 'success');
                                setTimeout(() => window.location.reload(), 1500);
                            })
                            .catch(err => showNotification('❌ ' + err.message, 'error'));
                    } else {
                        showNotification('❌ ' + error.message, 'error');
                    }
                });
        }

        function handleLogout() {
            if (confirm('هل تريد تسجيل الخروج؟')) {
                auth.signOut();
            }
        }

        // ==================== مراقبة حالة المستخدم ====================
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUser = user;
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('appScreen').style.display = 'flex';
                document.getElementById('userAvatar').textContent = user.email.charAt(0).toUpperCase();
                document.getElementById('userEmail').textContent = user.email;
                
                db.ref(`users/${user.uid}`).once('value', snap => {
                    const userData = snap.val();
                    currentUserRole = userData ? userData.role : 'admin';
                    
                    if (!userData) {
                        currentUserRole = 'admin';
                        db.ref(`users/${user.uid}`).set({
                            email: user.email,
                            role: 'admin',
                            createdAt: new Date().toISOString()
                        });
                    }
                    
                    db.ref('settings/permissions').once('value', snap => {
                        const perms = snap.val();
                        if (perms) {
                            userPermissions = perms;
                        } else {
                            db.ref('settings/permissions').set(userPermissions);
                        }
                        updateUIByRole();
                    });
                    
                    loadExcelFiles();
                });
            } else {
                document.getElementById('loginScreen').style.display = 'block';
                document.getElementById('appScreen').style.display = 'none';
            }
        });

        // ==================== تحديث واجهة المستخدم ====================
        function updateUIByRole() {
            const isAdmin = currentUserRole === 'admin';
            
            document.getElementById('usersTab').style.display = isAdmin ? 'flex' : 'none';
            document.getElementById('logsTab').style.display = isAdmin ? 'flex' : 'none';
            document.getElementById('backupsTab').style.display = isAdmin ? 'flex' : 'none';
            document.getElementById('uploadButtonContainer').style.display = isAdmin ? 'block' : 'none';
            
            if (document.getElementById('dynamicContent')) {
                renderSelectionPage();
            }
        }

        // ==================== تحميل ملفات Excel ====================
        function loadExcelFiles() {
            db.ref('excelFiles').once('value', snap => {
                if (!snap.exists() || Object.keys(snap.val()).length === 0) {
                    const defaultFileId = 'file_' + Date.now();
                    excelFiles = { [defaultFileId]: {
                        id: defaultFileId,
                        name: 'الملف الرئيسي',
                        createdAt: new Date().toISOString(),
                        createdBy: currentUser?.email || 'system'
                    }};
                    db.ref(`excelFiles/${defaultFileId}`).set(excelFiles[defaultFileId]);
                    
                    const defaultSheetId = 'sheet_' + Date.now();
                    sheets = { [defaultSheetId]: {
                        id: defaultSheetId,
                        name: 'ورقة1',
                        rows: 100,
                        cols: 26,
                        fileId: defaultFileId
                    }};
                    db.ref(`sheets/${defaultSheetId}`).set(sheets[defaultSheetId]);
                    initializeSheetData(defaultSheetId);
                } else {
                    excelFiles = snap.val();
                }
                
                currentExcelFile = Object.keys(excelFiles)[0];
                loadSheetsForFile(currentExcelFile);
            });
        }

        function loadSheetsForFile(fileId) {
            if (sheetsCache[fileId]) {
                sheets = sheetsCache[fileId];
                currentSheet = Object.keys(sheets)[0];
                renderSelectionPage();
                return;
            }
            
            db.ref('sheets').orderByChild('fileId').equalTo(fileId).once('value', snap => {
                sheets = snap.val() || {};
                sheetsCache[fileId] = sheets;
                
                if (Object.keys(sheets).length === 0) {
                    const sheetId = 'sheet_' + Date.now();
                    sheets = { [sheetId]: {
                        id: sheetId,
                        name: 'ورقة1',
                        rows: 100,
                        cols: 26,
                        fileId: fileId
                    }};
                    db.ref(`sheets/${sheetId}`).set(sheets[sheetId]);
                    initializeSheetData(sheetId);
                }
                
                currentSheet = Object.keys(sheets)[0];
                renderSelectionPage();
            });
        }

        function initializeSheetData(sheetId) {
            const sheet = sheets[sheetId];
            if (!sheet) return;
            
            const initialData = {};
            for (let r = 0; r < sheet.rows; r++) {
                initialData[r] = {};
                for (let c = 0; c < sheet.cols; c++) initialData[r][c] = '';
            }
            initialData._mergedCells = [];
            
            db.ref(`sheetData/${sheetId}`).set(initialData);
        }

        // ==================== صفحة اختيار الملفات والأوراق ====================
        function renderSelectionPage() {
            const content = document.getElementById('dynamicContent');
            if (!content) return;
            
            const isAdmin = currentUserRole === 'admin';
            const canView = userPermissions.view;
            
            if (!canView && !isAdmin) {
                content.innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: var(--gray-50);">
                        <div style="text-align: center; padding: 30px;">
                            <i class="fas fa-lock" style="font-size: 48px; color: var(--gray-400); margin-bottom: 16px;"></i>
                            <h3 style="font-size: 20px; font-weight: 800; color: var(--gray-700);">لا تملك صلاحية الوصول</h3>
                        </div>
                    </div>
                `;
                return;
            }
            
            let filesHTML = '';
            Object.keys(excelFiles).forEach(fileId => {
                const file = excelFiles[fileId];
                const isActive = fileId === currentExcelFile;
                filesHTML += `
                    <div class="file-card ${isActive ? 'active' : ''}" onclick="selectFile('${fileId}')">
                        ${isAdmin && Object.keys(excelFiles).length > 1 ? `
                            <button class="file-delete-btn" onclick="event.stopPropagation(); deleteExcelFile('${fileId}')">
                                <i class="fas fa-times"></i>
                            </button>
                        ` : ''}
                        <div class="file-card-icon">
                            <i class="fas fa-file-excel"></i>
                        </div>
                        <div class="file-card-name">${file.name}</div>
                        <div class="file-card-info">
                            ${new Date(file.createdAt).toLocaleDateString('ar-EG')}
                        </div>
                    </div>
                `;
            });
            
            if (isAdmin) {
                filesHTML += `
                    <div class="add-card" onclick="document.getElementById('excelFile').click()">
                        <i class="fas fa-plus"></i>
                        <span>رفع ملف جديد</span>
                    </div>
                `;
            }
            
            let sheetsHTML = '';
            Object.keys(sheets).forEach(sheetId => {
                const sheet = sheets[sheetId];
                const isActive = sheetId === currentSheet;
                sheetsHTML += `
                    <div class="sheet-card ${isActive ? 'active' : ''}" onclick="selectSheet('${sheetId}')">
                        ${isAdmin && Object.keys(sheets).length > 1 ? `
                            <button class="file-delete-btn" onclick="event.stopPropagation(); deleteSheet('${sheetId}')">
                                <i class="fas fa-times"></i>
                            </button>
                        ` : ''}
                        <div class="sheet-card-name">
                            <i class="fas fa-table"></i>
                            ${sheet.name}
                        </div>
                        <div class="sheet-card-info">
                            ${sheet.rows} × ${sheet.cols}
                        </div>
                    </div>
                `;
            });
            
            if (isAdmin) {
                sheetsHTML += `
                    <div class="add-card" onclick="showAddSheetModal()">
                        <i class="fas fa-plus"></i>
                        <span>إضافة ورقة</span>
                    </div>
                `;
            }
            
            content.innerHTML = `
                <div class="selection-page">
                    <div class="selection-section">
                        <div class="section-title">
                            <i class="fas fa-folder-open" style="color: var(--primary);"></i>
                            اختر الملف
                        </div>
                        <div class="files-grid">
                            ${filesHTML}
                        </div>
                    </div>
                    
                    <div class="selection-section">
                        <div class="section-title">
                            <i class="fas fa-table" style="color: var(--secondary);"></i>
                            اختر الورقة
                        </div>
                        <div class="sheets-grid">
                            ${sheetsHTML}
                        </div>
                    </div>
                    
                    <button class="open-table-btn" onclick="openTablePage()" ${!currentExcelFile || !currentSheet ? 'disabled' : ''}>
                        <i class="fas fa-arrow-left"></i>
                        <span>فتح الجدول</span>
                    </button>
                </div>
            `;
        }

        function selectFile(fileId) {
            currentExcelFile = fileId;
            loadSheetsForFile(fileId);
            showNotification(`✅ تم اختيار: ${excelFiles[fileId].name}`, 'success', 1500);
        }

        // ==================== التحسين: فتح تلقائي للورقة ====================
        function selectSheet(sheetId) {
            currentSheet = sheetId;
            showNotification(`✅ فتح: ${sheets[sheetId].name}`, 'success', 1000);
            setTimeout(() => openTablePage(), 300);
        }

        // ==================== فتح صفحة الجدول المستقلة ====================
        function openTablePage() {
            if (!currentExcelFile || !currentSheet) {
                showNotification('❌ يرجى اختيار ملف وورقة', 'error');
                return;
            }
            
            document.getElementById('tablePageFileName').textContent = excelFiles[currentExcelFile]?.name || 'ملف';
            document.getElementById('tablePageSheetName').textContent = sheets[currentSheet]?.name || 'ورقة';
            
            const isAdmin = currentUserRole === 'admin';
            
            // أزرار الإجراءات
            let actionsHTML = '';
            if (isAdmin) {
                actionsHTML = `
                    <button class="table-action-btn" onclick="downloadCurrentSheet()" title="تحميل">
                        <i class="fas fa-download"></i>
                    </button>
                    <button class="table-action-btn" onclick="createBackup()" title="نسخة احتياطية">
                        <i class="fas fa-save"></i>
                    </button>
                `;
            }
            document.getElementById('tablePageActions').innerHTML = actionsHTML;
            
            // شريط الأدوات
            let toolbarHTML = '';
            if (isAdmin) {
                toolbarHTML = `
                    <div class="table-toolbar">
                        <button class="tool-btn btn-success" onclick="addRow()">
                            <i class="fas fa-plus-circle"></i><span>صف</span>
                        </button>
                        <button class="tool-btn btn-success" onclick="addColumn()">
                            <i class="fas fa-plus-circle"></i><span>عمود</span>
                        </button>
                        <button class="tool-btn btn-danger" onclick="deleteCurrentSheet()">
                            <i class="fas fa-trash"></i><span>حذف</span>
                        </button>
                    </div>
                `;
            }
            document.getElementById('tablePageToolbar').innerHTML = toolbarHTML;
            
            // لوحة الصلاحيات
            let permissionsHTML = '';
            if (isAdmin) {
                permissionsHTML = `
                    <div class="permissions-panel">
                        <div class="permissions-title">
                            <i class="fas fa-user-shield"></i>
                            <span>الصلاحيات</span>
                        </div>
                        
                        <div class="permission-toggle">
                            <span><i class="fas fa-eye"></i> المشاهد</span>
                            <div class="toggle-switch ${userPermissions.view ? 'active' : ''}" onclick="togglePermission('view')">
                                <div class="toggle-slider"></div>
                            </div>
                            <span style="color: ${userPermissions.view ? 'var(--success)' : 'var(--gray-500)'}">
                                ${userPermissions.view ? '✓' : '✗'}
                            </span>
                        </div>
                        
                        <div class="permission-toggle">
                            <span><i class="fas fa-pen"></i> المعدل</span>
                            <div class="toggle-switch ${userPermissions.edit ? 'active' : ''}" onclick="togglePermission('edit')">
                                <div class="toggle-slider"></div>
                            </div>
                            <span style="color: ${userPermissions.edit ? 'var(--success)' : 'var(--gray-500)'}">
                                ${userPermissions.edit ? '✓' : '✗'}
                            </span>
                        </div>
                    </div>
                `;
            } else {
                const canEdit = userPermissions.view && userPermissions.edit;
                permissionsHTML = `
                    <div style="background: ${canEdit ? '#d1fae5' : '#fef3c7'}; padding: 10px 16px; border-bottom: 1px solid var(--gray-200); display: flex; align-items: center; gap: 10px;">
                        <i class="fas ${canEdit ? 'fa-pen' : 'fa-eye'}" style="color: ${canEdit ? 'var(--success)' : 'var(--warning)'};"></i>
                        <span style="font-weight: 600; color: var(--gray-800); font-size: 13px;">
                            ${canEdit ? 'لديك صلاحية التعديل' : 'لديك صلاحية المشاهدة فقط'}
                        </span>
                    </div>
                `;
            }
            document.getElementById('tablePagePermissions').innerHTML = permissionsHTML;
            
            document.getElementById('tablePage').classList.add('active');
            loadSheetData(currentSheet);
        }

        function closeTablePage() {
            document.getElementById('tablePage').classList.remove('active');
        }

        // ==================== تحميل بيانات الجدول ====================
        function loadSheetData(sheetId) {
            if (dataCache[sheetId]) {
                currentSheetData = dataCache[sheetId];
                mergedCells = currentSheetData._mergedCells || [];
                renderExcelTable();
                return;
            }
            
            db.ref(`sheetData/${sheetId}`).on('value', snap => {
                currentSheetData = snap.val() || {};
                dataCache[sheetId] = currentSheetData;
                mergedCells = currentSheetData._mergedCells || [];
                renderExcelTable();
            });
        }

        // ==================== رسم الجدول ====================
        function renderExcelTable() {
            const tableContainer = document.getElementById('tablePageContainer');
            if (!tableContainer) return;
            
            const sheet = sheets[currentSheet];
            if (!sheet) return;
            
            const isAdmin = currentUserRole === 'admin';
            const canEdit = isAdmin || (userPermissions.view && userPermissions.edit);
            
            let html = `<table><thead><tr>`;
            html += `<th class="row-header">#</th>`;
            for (let c = 0; c < sheet.cols; c++) {
                html += `<th>${String.fromCharCode(65 + c)}</th>`;
            }
            html += '</tr></thead><tbody>';
            
            for (let r = 0; r < sheet.rows; r++) {
                html += '<tr>';
                html += `<td class="row-header">${r + 1}</td>`;
                
                for (let c = 0; c < sheet.cols; c++) {
                    const value = currentSheetData?.[r]?.[c] || '';
                    
                    html += `<td 
                        ${canEdit ? 'contenteditable="true" class="editable-cell"' : 'class="view-only-cell"'}
                        onblur="updateCell(${r}, ${c}, this.textContent)"
                        ondblclick="this.focus()"
                    >${value}</td>`;
                }
                html += '</tr>';
            }
            
            html += '</tbody></table>';
            tableContainer.innerHTML = html;
        }

        // ==================== تحديث الخلية ====================
        function updateCell(row, col, value) {
            const canEdit = currentUserRole === 'admin' || (userPermissions.view && userPermissions.edit);
            if (!canEdit) {
                showNotification('❌ ليس لديك صلاحية التعديل', 'error');
                renderExcelTable();
                return;
            }
            
            const updates = {};
            updates[`${row}/${col}`] = value;
            updates[`${row}/${col}_editor`] = currentUser.email;
            updates[`${row}/${col}_time`] = new Date().toISOString();
            
            db.ref(`sheetData/${currentSheet}`).update(updates);
            if (dataCache[currentSheet]) {
                dataCache[currentSheet][row][col] = value;
            }
            
            if (currentUserRole === 'admin') {
                db.ref('logs').push({
                    user: currentUser.email,
                    file: excelFiles[currentExcelFile]?.name,
                    sheet: sheets[currentSheet]?.name,
                    action: `تعديل ${String.fromCharCode(65 + col)}${row + 1}`,
                    timestamp: new Date().toISOString()
                });
            }
        }

        // ==================== عمليات الجدول ====================
        function addRow() {
            if (currentUserRole !== 'admin') {
                showNotification('❌ فقط المدير يمكنه إضافة صفوف', 'error');
                return;
            }
            
            const sheet = sheets[currentSheet];
            if (sheet.rows >= MAX_ROWS) {
                showNotification(`⚠️ الحد الأقصى ${MAX_ROWS} صف`, 'warning');
                return;
            }
            
            sheet.rows++;
            const newRow = {};
            for (let c = 0; c < sheet.cols; c++) newRow[c] = '';
            
            db.ref(`sheets/${currentSheet}/rows`).set(sheet.rows);
            db.ref(`sheetData/${currentSheet}/${sheet.rows - 1}`).set(newRow);
            if (dataCache[currentSheet]) {
                dataCache[currentSheet][sheet.rows - 1] = newRow;
            }
            
            showNotification('✅ تم إضافة صف', 'success');
            renderExcelTable();
        }

        function addColumn() {
            if (currentUserRole !== 'admin') {
                showNotification('❌ فقط المدير يمكنه إضافة أعمدة', 'error');
                return;
            }
            
            const sheet = sheets[currentSheet];
            if (sheet.cols >= MAX_COLS) {
                showNotification(`⚠️ الحد الأقصى ${MAX_COLS} عمود`, 'warning');
                return;
            }
            
            sheet.cols++;
            for (let r = 0; r < sheet.rows; r++) {
                db.ref(`sheetData/${currentSheet}/${r}/${sheet.cols - 1}`).set('');
                if (dataCache[currentSheet]) {
                    dataCache[currentSheet][r][sheet.cols - 1] = '';
                }
            }
            
            db.ref(`sheets/${currentSheet}/cols`).set(sheet.cols);
            showNotification('✅ تم إضافة عمود', 'success');
            renderExcelTable();
        }

        function deleteExcelFile(fileId) {
            if (currentUserRole !== 'admin') return;
            if (Object.keys(excelFiles).length <= 1) {
                showNotification('❌ لا يمكن حذف الملف الأخير', 'error');
                return;
            }
            
            if (!confirm(`⚠️ حذف "${excelFiles[fileId].name}"؟`)) return;
            
            Object.keys(sheets).forEach(sheetId => {
                if (sheets[sheetId].fileId === fileId) {
                    db.ref(`sheets/${sheetId}`).remove();
                    db.ref(`sheetData/${sheetId}`).remove();
                    delete sheetsCache[fileId];
                    delete dataCache[sheetId];
                }
            });
            
            delete excelFiles[fileId];
            db.ref(`excelFiles/${fileId}`).remove();
            
            currentExcelFile = Object.keys(excelFiles)[0];
            loadSheetsForFile(currentExcelFile);
            showNotification('✅ تم حذف الملف', 'success');
        }

        function deleteSheet(sheetId) {
            if (currentUserRole !== 'admin') return;
            if (Object.keys(sheets).length <= 1) {
                showNotification('❌ لا يمكن حذف الورقة الأخيرة', 'error');
                return;
            }
            
            if (!confirm(`⚠️ حذف "${sheets[sheetId].name}"؟`)) return;
            
            delete sheets[sheetId];
            sheetsCache[currentExcelFile] = sheets;
            db.ref(`sheets/${sheetId}`).remove();
            db.ref(`sheetData/${sheetId}`).remove();
            delete dataCache[sheetId];
            
            currentSheet = Object.keys(sheets)[0];
            renderSelectionPage();
            showNotification('✅ تم حذف الورقة', 'success');
        }

        function deleteCurrentSheet() {
            if (currentSheet) {
                deleteSheet(currentSheet);
                closeTablePage();
            }
        }

        // ==================== تبديل الصلاحيات ====================
        function togglePermission(permType) {
            if (currentUserRole !== 'admin') {
                showNotification('❌ هذه الخاصية متاحة للمدير فقط', 'error');
                return;
            }
            
            userPermissions[permType] = !userPermissions[permType];
            
            db.ref('settings/permissions').set(userPermissions)
                .then(() => {
                    showNotification(`✅ تم ${userPermissions[permType] ? 'تفعيل' : 'تعطيل'} صلاحية ${permType === 'view' ? 'المشاهدة' : 'التعديل'}`, 'success');
                    openTablePage();
                })
                .catch(error => {
                    showNotification('❌ خطأ في حفظ الصلاحيات', 'error');
                });
        }

        // ==================== إدارة الأوراق ====================
        function showAddSheetModal() {
            if (currentUserRole !== 'admin') {
                showNotification('❌ فقط المدير يمكنه إضافة أوراق', 'error');
                return;
            }
            
            document.getElementById('newSheetNameInput').value = `ورقة ${Object.keys(sheets).length + 1}`;
            document.getElementById('addSheetModal').style.display = 'flex';
        }

        function createNewSheet() {
            if (currentUserRole !== 'admin') return;
            
            const sheetName = document.getElementById('newSheetNameInput').value.trim();
            if (!sheetName) {
                showNotification('❌ يرجى إدخال اسم الورقة', 'error');
                return;
            }
            
            const sheetId = `sheet_${Date.now()}`;
            const newSheet = {
                id: sheetId,
                name: sheetName,
                rows: 50,
                cols: 26,
                fileId: currentExcelFile,
                createdAt: new Date().toISOString()
            };
            
            sheets[sheetId] = newSheet;
            sheetsCache[currentExcelFile] = sheets;
            db.ref(`sheets/${sheetId}`).set(newSheet);
            initializeSheetData(sheetId);
            
            hideModal('addSheetModal');
            currentSheet = sheetId;
            renderSelectionPage();
            showNotification(`✅ تم إنشاء "${sheetName}"`, 'success');
        }

        function hideModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // ==================== رفع وتحميل Excel ====================
        function uploadExcel() {
            if (currentUserRole !== 'admin') {
                showNotification('❌ فقط المدير يمكنه رفع الملفات', 'error');
                return;
            }
            
            const file = document.getElementById('excelFile').files[0];
            if (!file) return;
            
            showNotification('⏳ جاري الرفع...', 'info');
            
            const reader = new FileReader();
            reader.onload = e => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    const fileId = 'file_' + Date.now();
                    const fileName = file.name.replace('.xlsx', '').replace('.xls', '').substring(0, 20);
                    
                    const newExcelFile = {
                        id: fileId,
                        name: fileName,
                        createdAt: new Date().toISOString(),
                        createdBy: currentUser.email
                    };
                    
                    excelFiles[fileId] = newExcelFile;
                    db.ref(`excelFiles/${fileId}`).set(newExcelFile);
                    
                    let sheetsForFile = {};
                    
                    workbook.SheetNames.forEach((sheetName, index) => {
                        const sheetId = `sheet_${Date.now()}_${index}`;
                        const worksheet = workbook.Sheets[sheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: '' });
                        const merges = worksheet['!merges'] || [];
                        const mergedCells = merges.map(merge => ({
                            row: merge.s.r, col: merge.s.c,
                            rowspan: merge.e.r - merge.s.r + 1,
                            colspan: merge.e.c - merge.s.c + 1
                        }));
                        
                        const cleanData = jsonData.filter(row => row.some(cell => cell !== ''));
                        
                        const newSheet = {
                            id: sheetId,
                            name: sheetName.substring(0, 20),
                            rows: cleanData.length || 30,
                            cols: cleanData.length > 0 ? Math.max(...cleanData.map(row => row.length), 20) : 20,
                            fileId: fileId
                        };
                        
                        sheetsForFile[sheetId] = newSheet;
                        db.ref(`sheets/${sheetId}`).set(newSheet);
                        
                        const sheetData = {};
                        cleanData.forEach((row, r) => {
                            sheetData[r] = {};
                            row.forEach((cell, c) => sheetData[r][c] = cell?.toString() || '');
                        });
                        sheetData._mergedCells = mergedCells;
                        
                        db.ref(`sheetData/${sheetId}`).set(sheetData);
                        dataCache[sheetId] = sheetData;
                    });
                    
                    sheetsCache[fileId] = sheetsForFile;
                    showNotification(`✅ تم استيراد ${workbook.SheetNames.length} ورقة`, 'success');
                    
                    currentExcelFile = fileId;
                    loadSheetsForFile(fileId);
                    document.getElementById('excelFile').value = '';
                    
                } catch (error) {
                    showNotification('❌ خطأ في الملف', 'error');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function downloadCurrentSheet() {
            if (currentUserRole !== 'admin') {
                showNotification('❌ فقط المدير يمكنه تحميل الملفات', 'error');
                return;
            }
            
            const sheet = sheets[currentSheet];
            const rows = [];
            for (let r = 0; r < sheet.rows; r++) {
                const row = [];
                for (let c = 0; c < sheet.cols; c++) {
                    row.push(currentSheetData?.[r]?.[c] || '');
                }
                rows.push(row);
            }
            
            const worksheet = XLSX.utils.aoa_to_sheet(rows);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, sheet.name);
            XLSX.writeFile(workbook, `${sheet.name}.xlsx`);
            showNotification('✅ تم التحميل', 'success');
        }

        // ==================== إدارة التبويبات ====================
        function switchMainTab(tab, element) {
            if (tab !== 'excel' && currentUserRole !== 'admin') {
                showNotification('❌ فقط المدير يمكنه الوصول لهذا القسم', 'error');
                return;
            }
            
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            element.classList.add('active');
            
            if (tab === 'excel') {
                renderSelectionPage();
            } else if (tab === 'users') {
                renderUsersManagement();
            } else if (tab === 'logs') {
                renderLogsViewer();
            } else if (tab === 'backups') {
                renderBackupsViewer();
            }
        }

        // ==================== إدارة المستخدمين مع التحسينات ====================
        function renderUsersManagement() {
            if (currentUserRole !== 'admin') return;
            
            const content = document.getElementById('dynamicContent');
            content.innerHTML = `
                <div class="users-container">
                    <div class="users-header">
                        <h2><i class="fas fa-users" style="color: var(--primary);"></i> إدارة المستخدمين</h2>
                    </div>
                    
                    <div class="add-user-card">
                        <h3 style="margin-bottom: 16px;"><i class="fas fa-user-plus" style="color: var(--success);"></i> إضافة مستخدم</h3>
                        <div class="add-user-form">
                            <input type="email" id="newUserEmail" class="login-input" placeholder="البريد الإلكتروني">
                            <input type="password" id="newUserPassword" class="login-input" placeholder="كلمة المرور">
                            <select id="newUserRole" class="role-select">
                                <option value="view">👁️ مشاهد</option>
                                <option value="edit">✏️ معدل</option>
                                <option value="admin">👑 مدير</option>
                            </select>
                            <button class="tool-btn btn-success" onclick="addUser()" style="height: 52px;">
                                <i class="fas fa-plus"></i> إضافة
                            </button>
                        </div>
                    </div>
                    
                    <div class="users-list" style="background: white; padding: 20px; border-radius: 16px;">
                        <h3 style="margin-bottom: 16px;"><i class="fas fa-list"></i> قائمة المستخدمين</h3>
                        <div id="usersListContainer"></div>
                    </div>
                </div>
            `;
            loadUsersList();
        }

        function loadUsersList() {
            db.ref('users').once('value', snap => {
                const users = snap.val() || {};
                const container = document.getElementById('usersListContainer');
                if (!container) return;
                
                container.innerHTML = '';
                
                Object.entries(users).forEach(([uid, user]) => {
                    const isCurrentUser = uid === currentUser.uid;
                    const roleIcon = user.role === 'admin' ? '👑' : user.role === 'edit' ? '✏️' : '👁️';
                    const roleName = user.role === 'admin' ? 'مدير' : user.role === 'edit' ? 'معدل' : 'مشاهد';
                    
                    container.innerHTML += `
                        <div class="user-item" style="border: ${isCurrentUser ? '2px solid var(--primary)' : 'none'};">
                            <div class="user-info" style="flex: 1;">
                                <div style="font-weight: 700; margin-bottom: 10px; font-size: 16px;">
                                    ${user.email} ${isCurrentUser ? '<span style="background: var(--primary); color: white; padding: 2px 10px; border-radius: 40px; font-size: 12px; margin-right: 8px;">أنت</span>' : ''}
                                </div>
                                <div style="margin-bottom: 12px;">
                                    <span style="background: ${user.role === 'admin' ? '#fee2e2' : user.role === 'edit' ? '#dbeafe' : '#fef3c7'}; padding: 6px 14px; border-radius: 40px; font-size: 13px; font-weight: 600;">
                                        ${roleIcon} ${roleName}
                                    </span>
                                </div>
                                
                                ${!isCurrentUser ? `
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px;">
                                        <button onclick="changeUserRole('${uid}', 'admin')" 
                                            style="padding: 6px 12px; border-radius: 8px; border: 2px solid ${user.role === 'admin' ? 'var(--danger)' : 'var(--gray-300)'}; background: ${user.role === 'admin' ? '#fee2e2' : 'white'}; cursor: pointer; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 4px;">
                                            <i class="fas fa-crown"></i> مدير
                                        </button>
                                        <button onclick="changeUserRole('${uid}', 'edit')" 
                                            style="padding: 6px 12px; border-radius: 8px; border: 2px solid ${user.role === 'edit' ? 'var(--secondary)' : 'var(--gray-300)'}; background: ${user.role === 'edit' ? '#dbeafe' : 'white'}; cursor: pointer; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 4px;">
                                            <i class="fas fa-pen"></i> معدل
                                        </button>
                                        <button onclick="changeUserRole('${uid}', 'view')" 
                                            style="padding: 6px 12px; border-radius: 8px; border: 2px solid ${user.role === 'view' ? 'var(--warning)' : 'var(--gray-300)'}; background: ${user.role === 'view' ? '#fef3c7' : 'white'}; cursor: pointer; font-size: 12px; font-weight: 600; display: flex; align-items: center; gap: 4px;">
                                            <i class="fas fa-eye"></i> مشاهد
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                            ${!isCurrentUser ? `
                                <button class="delete-user-btn" onclick="deleteUser('${uid}')" style="background: var(--danger); color: white; border: none; padding: 10px 18px; border-radius: 10px; font-size: 13px; display: flex; align-items: center; gap: 6px; cursor: pointer; align-self: flex-start;">
                                    <i class="fas fa-trash"></i> حذف
                                </button>
                            ` : ''}
                        </div>
                    `;
                });
            });
        }

        // ==================== التحسين: تغيير صلاحيات المستخدم ====================
        function changeUserRole(uid, newRole) {
            if (currentUserRole !== 'admin') {
                showNotification('❌ فقط المدير يمكنه تغيير الصلاحيات', 'error');
                return;
            }
            
            db.ref(`users/${uid}`).once('value', snap => {
                const user = snap.val();
                if (user && user.role === newRole) {
                    showNotification('ℹ️ المستخدم لديه هذه الصلاحية بالفعل', 'info');
                    return;
                }
                
                const roleNames = {
                    'admin': 'مدير',
                    'edit': 'معدل',
                    'view': 'مشاهد'
                };
                
                db.ref(`users/${uid}/role`).set(newRole)
                    .then(() => {
                        showNotification(`✅ تم تغيير الصلاحية إلى: ${roleNames[newRole]}`, 'success');
                        loadUsersList();
                    })
                    .catch(error => {
                        showNotification('❌ خطأ في تغيير الصلاحية', 'error');
                    });
            });
        }

        function addUser() {
            if (currentUserRole !== 'admin') return;
            
            const email = document.getElementById('newUserEmail').value.trim();
            const password = document.getElementById('newUserPassword').value.trim();
            const role = document.getElementById('newUserRole').value;
            
            if (!email || !password) {
                showNotification('❌ يرجى إدخال البريد وكلمة المرور', 'error');
                return;
            }
            
            if (password.length < 8) {
                showNotification('❌ كلمة المرور 8 أحرف على الأقل', 'error');
                return;
            }
            
            auth.createUserWithEmailAndPassword(email, password)
                .then(cred => {
                    return db.ref(`users/${cred.user.uid}`).set({
                        email: email,
                        role: role,
                        createdBy: currentUser.email,
                        createdAt: new Date().toISOString()
                    });
                })
                .then(() => {
                    showNotification('✅ تم إضافة المستخدم', 'success');
                    document.getElementById('newUserEmail').value = '';
                    document.getElementById('newUserPassword').value = '';
                    loadUsersList();
                })
                .catch(error => {
                    if (error.code === 'auth/email-already-in-use') {
                        showNotification('❌ البريد الإلكتروني مستخدم بالفعل', 'error');
                    } else {
                        showNotification('❌ ' + error.message, 'error');
                    }
                });
        }

        function deleteUser(uid) {
            if (!confirm('⚠️ حذف المستخدم؟')) return;
            
            db.ref(`users/${uid}`).remove()
                .then(() => {
                    showNotification('✅ تم حذف المستخدم', 'success');
                    loadUsersList();
                });
        }

        // ==================== سجل التعديلات ====================
        function renderLogsViewer() {
            if (currentUserRole !== 'admin') return;
            
            const content = document.getElementById('dynamicContent');
            content.innerHTML = `
                <div class="logs-container">
                    <div class="logs-header">
                        <h2><i class="fas fa-history" style="color: var(--primary);"></i> سجل التعديلات</h2>
                    </div>
                    <div class="logs-list" id="logsListContainer"></div>
                </div>
            `;
            loadLogs();
        }

        function loadLogs() {
            db.ref('logs').orderByChild('timestamp').limitToLast(100).on('value', snap => {
                const logs = snap.val() || {};
                const container = document.getElementById('logsListContainer');
                if (!container) return;
                
                if (Object.keys(logs).length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 30px;">لا توجد تعديلات بعد</p>';
                    return;
                }
                
                container.innerHTML = '';
                Object.values(logs).reverse().forEach(log => {
                    const date = new Date(log.timestamp);
                    container.innerHTML += `
                        <div class="log-item">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                <span style="font-weight: 700; color: var(--primary);">${log.user}</span>
                                <span style="color: var(--gray-500); font-size: 12px;">${date.toLocaleString('ar-EG')}</span>
                            </div>
                            <div style="color: var(--gray-700);">${log.action}</div>
                        </div>
                    `;
                });
            });
        }

        // ==================== النسخ الاحتياطية ====================
        function renderBackupsViewer() {
            if (currentUserRole !== 'admin') return;
            
            const content = document.getElementById('dynamicContent');
            content.innerHTML = `
                <div class="backups-container">
                    <div class="backups-header">
                        <h2><i class="fas fa-archive" style="color: var(--purple);"></i> النسخ الاحتياطية</h2>
                    </div>
                    
                    <button class="create-backup-btn" onclick="createBackup()">
                        <i class="fas fa-save"></i> إنشاء نسخة احتياطية
                    </button>
                    
                    <div class="backups-list" id="backupsListContainer"></div>
                </div>
            `;
            loadBackups();
        }

        function loadBackups() {
            db.ref(`backups/${currentExcelFile}`).orderByChild('createdAt').once('value', snap => {
                const backups = snap.val() || {};
                const container = document.getElementById('backupsListContainer');
                if (!container) return;
                
                if (Object.keys(backups).length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--gray-500); padding: 30px;">لا توجد نسخ احتياطية</p>';
                    return;
                }
                
                container.innerHTML = '';
                Object.values(backups).reverse().forEach(backup => {
                    const date = new Date(backup.createdAt);
                    container.innerHTML += `
                        <div class="backup-item">
                            <div class="backup-info">
                                <span style="font-weight: 700; color: var(--purple);">${backup.name}</span>
                                <div class="backup-details">
                                    <span>${backup.fileName}</span>
                                    <span>${backup.sheetName}</span>
                                    <span>${date.toLocaleString('ar-EG')}</span>
                                </div>
                            </div>
                            <button class="restore-backup-btn" onclick="restoreBackup('${backup.id}')">
                                <i class="fas fa-undo"></i> استعادة
                            </button>
                        </div>
                    `;
                });
            });
        }

        function createBackup() {
            if (currentUserRole !== 'admin') {
                showNotification('❌ فقط المدير يمكنه إنشاء نسخ', 'error');
                return;
            }
            
            if (!currentSheet) {
                showNotification('❌ يرجى فتح ورقة أولاً', 'error');
                return;
            }
            
            const backupId = `backup_${Date.now()}`;
            const backupName = `نسخة ${new Date().toLocaleDateString('ar-EG')}`;
            
            const backupData = {
                id: backupId,
                name: backupName,
                fileId: currentExcelFile,
                fileName: excelFiles[currentExcelFile]?.name,
                sheetId: currentSheet,
                sheetName: sheets[currentSheet]?.name,
                data: currentSheetData,
                createdBy: currentUser.email,
                createdAt: new Date().toISOString()
            };
            
            db.ref(`backups/${currentExcelFile}/${backupId}`).set(backupData)
                .then(() => {
                    showNotification('✅ تم إنشاء نسخة احتياطية', 'success');
                });
        }

        function restoreBackup(backupId) {
            if (currentUserRole !== 'admin') {
                showNotification('❌ فقط المدير يمكنه استعادة النسخ', 'error');
                return;
            }
            
            if (!confirm('⚠️ استعادة هذه النسخة؟')) return;
            
            db.ref(`backups/${currentExcelFile}/${backupId}`).once('value', snap => {
                const backup = snap.val();
                if (backup) {
                    db.ref(`sheetData/${currentSheet}`).set(backup.data)
                        .then(() => {
                            showNotification('✅ تم استعادة النسخة', 'success');
                            if (dataCache[currentSheet]) {
                                dataCache[currentSheet] = backup.data;
                            }
                            renderExcelTable();
                        });
                }
            });
        }

        // ==================== الإشعارات ====================
        function showNotification(message, type = 'info', duration = 2500) {
            const notification = document.getElementById('notification');
            const icon = type === 'success' ? 'fa-check-circle' : 
                        type === 'error' ? 'fa-exclamation-circle' : 
                        type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';
            
            notification.innerHTML = `<i class="fas ${icon}"></i> <span>${message}</span>`;
            notification.style.background = type === 'success' ? 'var(--success)' : 
                                           type === 'error' ? 'var(--danger)' : 
                                           type === 'warning' ? 'var(--warning)' : 'var(--info)';
            notification.style.display = 'flex';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, duration);
        }

        window.addEventListener('unhandledrejection', function(event) {
            console.error('Firebase Error:', event.reason);
        });
    </script>
</body>
</html>
